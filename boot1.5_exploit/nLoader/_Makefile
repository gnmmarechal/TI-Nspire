CFLAGS := -Wall -Werror -O3 -mcpu=arm926ej-s -nostdlib -nostartfiles -ffreestanding -fno-builtin -std=gnu11 -fPIE
LDFLAGS = -nostdlib -nostartfiles -T ldscript -PIE -flto


OBJS = $(patsubst %.c, %.o, $(shell find . -depth 1 -type f -name \*.c))
OBJS += $(patsubst %.cpp, %.o, $(shell find . -depth 1 -type f -name \*.cpp))
OBJS += $(patsubst %.S, %.o, $(shell find . -depth 1 -type f -name \*.S))

all: loader.bin

%.o: %.S
	arm-none-eabi-gcc -c $^ -o $@

%.o: %.c
	arm-none-eabi-gcc -c $^ -o $@ $(CFLAGS)

loader.elf: $(OBJS)
	arm-none-eabi-ld $(LDFLAGS) libgcc/*.o $^ -o $@

loader.bin: loader.elf
	arm-none-eabi-objcopy -O binary $^ $@
	rm -f loader.elf $(OBJS)

clean:
	rm -f loader.bin loader.elf $(OBJS)

.PHONY: clean
