#include "utils.h"
#include "screen.h"
#include "casos.h"
#include "imageloader.h"

asm(".section .text._start\n"
	"_start: .global _start\n"
	"ldr sp, =#0x10400000\n"
	"b main\n");


extern int patch_Boot2();
extern int ndless_loader();

int load_boot2() {
	char *BOOT2_PTR = *(char**)(0x111FFFF8);
	uint32_t BOOT2_SIZE = *(uint32_t*)(0x111FFFFC);
	if(decompressFiles(BOOT2_PTR,BOOT2_SIZE,(void *) 0x11800000)) {
		if(!patch_Boot2()) {
			puts("Wrong boot2 version");
			return 0;
		} else {
			if(!ndless_loader()) {
				puts("Ndless loader failed");
				return 0;
			}
		}
		return 1;
	} else {
		puts("Can't decompress boot2");
		return 0;
	}
}

void main()
{	
	ut_disable_watchdog();
	init_screen();
	puts("\r\nnLoader: Created by parrotgeek1. Version: beta 1");
#ifndef CAS_OS
	puts("Non-CAS OS mode");
#else
#ifdef CAS_OS_no_patches
	puts("CAS OS mode (no patches)");
#else
	puts("CAS OS mode");
#endif
	if(asicflags() != 1) drawCasWarning();
#endif
#if 0 // unsafe on CR4
	*(volatile uint32_t*)0x900B0000 = 0x0030A002; // safe overclock to base=198MHz cpu=198MHz ahb=66MHz
	*(volatile uint32_t*)0x900B000C = 0x00000004;
#endif
	if(load_boot2()) {
		puts("nLoader: Loading complete, launching image.");
		unsigned dummy;
		__asm volatile(
			"0: mrc p15, 0, r15, c7, c10, 3 @ test and clean DCache \n"
			" bne 0b \n"
			" mov %0, #0 \n"
			" mcr p15, 0, %0, c7, c7, 0 @ invalidate ICache and DCache \n" : "=r" (dummy));
		asm(
			".arm \n"
			"ldr pc, =0x11800000 \n"
		);
	} else {
		puts("nLoader: Error reading/validating BOOT2 image");
		draw_error(); // boot1.5 does not do this
	}
	while(1);
	__builtin_unreachable();
}
