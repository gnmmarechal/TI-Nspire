#include "types.h"
#include "patchboot2.h"
#include "utils.h"
#include "casos.h"
#include "casimage.h"
#ifdef CAS_OS
#ifndef CAS_OS_no_patches
#include "../../patchfinder/patcher44cas.h"
#include "../../patchfinder/patcher45cas.h"
#endif
#endif
#ifdef NONCAS_OS
#include "../../patchfinder/patcher44ncas.h"
#include "../../patchfinder/patcher45ncas.h"
#endif
#include "patcherloc.h"

extern unsigned char __ndless_loader_start__;
extern unsigned char __ndless_loader_end__;

asm(R"nLoader(
    .globl __ndless_loader_start__
    .globl __ndless_loader_end__
    __ndless_loader_start__:
    .incbin "ndless_loader.bin"
    __ndless_loader_end__:
    )nLoader");

#ifdef CAS_OS
extern unsigned char __casimage_start__;
extern unsigned char __casimage_end__;
asm(R"nLoader(
    .globl __casimage_start__
    .globl __casimage_end__
    __casimage_start__:
    .incbin "show_cas_image.bin"
    __casimage_end__:
    )nLoader");
extern unsigned char __casimagecr4_start__;
extern unsigned char __casimagecr4_end__;
asm(R"nLoader(
    .globl __casimagecr4_start__
    .globl __casimagecr4_end__
    __casimagecr4_start__:
    .incbin "show_cas_image_cr4.bin"
    __casimagecr4_end__:
    )nLoader");
#endif

int ndless_loader() {
    uint32_t ID = *((uint32_t*)(0x11800020));
    if(ID == CXB440_8) {
        uint8_t *ndless_loader_start=&__ndless_loader_start__, *ndless_loader_end=&__ndless_loader_end__;
#ifdef CAS_OS
        uint8_t *casimage_start=& __casimage_start__, *casimage_end=& __casimage_end__;
        uint8_t *casimagecr4_start=& __casimagecr4_start__, *casimagecr4_end=& __casimagecr4_end__;
#endif

        memcpy((void *) NDLESS_LOC, ndless_loader_start , ndless_loader_end-ndless_loader_start);
        // new 1187D300 prestage - where it prints
        // somehow this is the same in 4.0.3 and 4.4.0.8. lucky!
        /*
         RAM:118EC8B0 aBoot2Loading_0 DCB 0xD,0xA             ; DATA XREF: sub_1187D2DC:loc_1187D334↑o
         RAM:118EC8B0                                         ; RAM:off_1187D348↑o
         RAM:118EC8B0                 DCB "BOOT2: loading complete (%d ticks), launching image.",0xD,0xA,0


         RAM:1187D2FC                 ADD     R2, R4, #0x6C
         RAM:1187D300                 LDR     R0, =aBoot2LoadingCo ; "\r\nBOOT2: loading complete (%d ticks),"...
         RAM:1187D304                 BL      sub_118D08E4

         */
        *(volatile unsigned int *)0x1187d300 = 0xe51ff004; // jump to below value
        *(volatile unsigned int *)0x1187d304 = NDLESS_LOC;
#ifdef CAS_OS
if(asicflags() != 1 && asicflags() != 3) {
	// cas image is where it prints loading operating system
        *(volatile unsigned int *)0x1187e9b4 = 0xe51ff004; // jump to below value
        *(volatile unsigned int *)0x1187e9b8 = SHOWCASIMAGE_LOC;

        if(iscr4()) memcpy((void *) SHOWCASIMAGE_LOC, casimagecr4_start , casimagecr4_end-casimagecr4_start);
	else memcpy((void *) SHOWCASIMAGE_LOC, casimage_start , casimage_end-casimage_start);
        memcpy((void *) DATACASIMAGE_LOC, casimage , 29*12*2);
}
#endif
	
#ifdef CAS_OS
#ifndef CAS_OS_no_patches
        memcpy((void *)PATCHER44CAS_LOC, patcher44cas, patcher44cas_len);
        memcpy((void *)PATCHER45CAS_LOC, patcher45cas, patcher45cas_len);
#endif
#endif
#ifdef NONCAS_OS
        memcpy((void *)PATCHER44NCAS_LOC, patcher44ncas, patcher44ncas_len);
        memcpy((void *)PATCHER45NCAS_LOC, patcher45ncas, patcher45ncas_len);
#endif
        return 1;
    } else {
        puts("Bad boot2 for ndless loader");
        return 0;
    }
}
