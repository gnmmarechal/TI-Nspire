GCC = arm-none-eabi-gcc
LD = arm-none-eabi-ld
GCCFLAGS = -Os -Wall -W -marm -mcpu=arm926ej-s -nostdlib -nostartfiles -s -fPIE -ffreestanding -std=c11
LDFLAGS = -nostdlib -nostartfiles -e ndless_loader -PIE -T ldscript
OBJCOPY := "$(shell which arm-elf-objcopy 2>/dev/null)"
ifeq (${OBJCOPY},"")
	OBJCOPY := arm-none-eabi-objcopy
endif
BIN = ../ndless_loader.bin

# WARNING : each of the 6 different payloads (CX, CXCAS, CM, CMCAS, CXDVT, CXCASDVT) has to fit within the Boot2
# with Boot2 4.0.3 1760KiB is ok - 1800KiB is not ok
# DO NOT include all OS patches !

all: $(BIN)

ndless_loader.o: ndless_loader.c
	$(GCC) $(GCCFLAGS) -o $@ $(PATCHES) -c $<

$(BIN): ndless_loader.o
	$(LD) $(LDFLAGS) $^ -o $(<:.o=.elf)
	$(OBJCOPY) -O binary $(<:.o=.elf) $@
clean:
	rm -f *.o *.elf
	rm -f $(BIN)