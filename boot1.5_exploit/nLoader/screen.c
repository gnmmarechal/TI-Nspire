#include "types.h"
#include "boot1.h"
#include "utils.h"
#include "screen.h"
#include "error.h"
#include "bar.h"

#include "caswarning.h"

uint16_t* SCREEN_BASE_ADDR = 0;

static int CR4 = 0;

void init_screen() {
	SCREEN_BASE_ADDR = *(uint16_t**)SCREEN_BASE_PTR;
	CR4 = iscr4();
}

void drawBar(int bufwidth, int shiftx, int shifty, uint16_t color) {
	for(int y = 0; y < (136-104); y++) {
		for(int x = 0; x < bufwidth; x++){
			if(!CR4) {
				SCREEN_BASE_ADDR[(shifty+y)*SCREEN_WIDTH+(shiftx+x)]=color;
			}
			else {
				SCREEN_BASE_ADDR[(shiftx+x)*SCREEN_HEIGHT+(shifty+y)]=color;
			}
		}
	}
}

void drawImage(uint16_t* buf, int bufwidth, int bufheight, int shiftx, int shifty, int trsp) {
	for(int y = 0; y < bufheight; y++) {
		for(int x = 0; x < bufwidth; x++){
			if(!trsp || buf[y*bufwidth+x] != MAGENTA) {
				if(!CR4) {
					SCREEN_BASE_ADDR[(shifty+y)*SCREEN_WIDTH+(shiftx+x)]=(buf[y*bufwidth+x]);
				}
				else {
					SCREEN_BASE_ADDR[(shiftx+x)*SCREEN_HEIGHT+(shifty+y)]=(buf[y*bufwidth+x]);			
				}
			}
		}
	} 
}

void drawBarImage(int bufwidth, int shiftx, int shifty) {
	for(int y = 0; y < 12; y++) {
		for(int x = 0; x < bufwidth; x++){
				if(!CR4) {
					SCREEN_BASE_ADDR[(shifty+y)*SCREEN_WIDTH+(shiftx+x)]=(bar_216x12[y*216+x]);
				}
				else {
					SCREEN_BASE_ADDR[(shiftx+x)*SCREEN_HEIGHT+(shifty+y)]=(bar_216x12[y*216+x]);			
				}
		}
	} 
}

void draw_error() {
	if(SCREEN_BASE_ADDR[0] == 0xFFFF) {
	// no manuf
	drawImage(error,30,30,(SCREEN_WIDTH-30)/2, SCREEN_HEIGHT-48,1);
	} else {
	drawImage(error,30,30,(SCREEN_WIDTH-30)/2, SCREEN_HEIGHT-96,1);
	}
}  

#include "casos.h"
#ifdef CAS_OS
void drawCasWarning() {
	// DO NOT EDIT THIS it is for development. 
	if(*(volatile unsigned int *)0xa4012eb4 == 0xabadc0de) return;

	char backup[320*240*2];
	memcpy(backup,SCREEN_BASE_ADDR,320*240*2);
	drawImage(caswarning,320,240,0,0,1);
	// delay about 10s
	for(volatile int i = 0; i < 200000000; i++) { }
	memcpy(SCREEN_BASE_ADDR,backup,320*240*2);
}
#endif
